<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HATU - H·ªèi ƒê√°p Thi√™n VƒÉn</title>
  <style>
    body {
      background-color: #0d0d0d;
      color: #ffffff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #00bcd4;
      text-align: center;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .question-box, .answer-box {
      background: #1a1a1a;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px #00bcd4;
      position: relative;
    }
    .input-field, textarea {
      width: 97%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
      background: #333;
      color: #fff;
    }
    .button {
      background-color: #00bcd4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    .button:hover {
      background-color: #008ba3;
    }
    .qa h2 {
      color: #ffc107;
      margin-bottom: 15px;
    }
    .qa h3 {
      color: #f0f0f0;
      margin: 6px 0;
    }
    .meta {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 12px;
      color: #aaa;
    }
    .replies {
      margin-left: 20px;
      margin-top: 10px;
    }
    .reply-item {
      background: #222;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 14px;
    }
    .reply-btn {
      background: transparent;
      border: 1px solid #00bcd4;
      color: #00bcd4;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .reply-btn:hover {
      background: #00bcd4;
      color: #000;
    }
    #replyPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 90%;
      max-width: 400px;
      transform: translate(-50%, -50%);
      background: #222;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 15px #00bcd4;
      z-index: 9999;
    }
    #replyPopup h3 {
      margin-top: 0;
      color: #00bcd4;
    }
    #replyPopup label {
      font-size: 14px;
      margin-top: 10px;
      display: block;
    }
    #replyPopup input, #replyPopup textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: none;
      background: #333;
      color: #fff;
    }
    #replyPopup .button {
      margin-top: 15px;
      width: 100%;
    }
    #overlay {
      display: none;
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.6);
      z-index: 9998;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü™ê HATU - H·ªèi ƒê√°p Thi√™n VƒÉn</h1>

    <div class="question-box">
      <h2>ƒê·∫∑t c√¢u h·ªèi</h2>
      <input type="text" class="input-field" id="username" placeholder="T√™n c·ªßa b·∫°n (b·∫Øt bu·ªôc)" />
      <textarea rows="4" id="question" class="input-field" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n v·ªÅ thi√™n vƒÉn..."></textarea>
      <button class="button" onclick="submitQuestion()">G·ª≠i c√¢u h·ªèi</button>
    </div>

    <div class="qa" id="qa-section">
      <h2>C√°c c√¢u h·ªèi ƒë√£ g·ª≠i:</h2>
      <!-- N·ªôi dung c√¢u h·ªèi s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y -->
    </div>
  </div>

  <div id="overlay"></div>

  <div id="replyPopup">
    <h3>Tr·∫£ l·ªùi c√¢u h·ªèi</h3>
    <p><b>C√¢u h·ªèi:</b> <span id="replyQuestionText"></span></p>
    <label for="replyName">T√™n c·ªßa b·∫°n (b·∫Øt bu·ªôc):</label>
    <input type="text" id="replyName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" />
    <label for="replyText">C√¢u tr·∫£ l·ªùi (b·∫Øt bu·ªôc):</label>
    <textarea id="replyText" rows="4" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi"></textarea>
    <button class="button" onclick="submitReply()">G·ª≠i tr·∫£ l·ªùi</button>
    <button class="button" style="background:#555;margin-top:8px;" onclick="closeReplyPopup()">H·ªßy</button>
  </div>

<!-- _________________________________ -->

  <script>
  const sheetID = '18cFMlSc7dlwHNZlUQ5y7BMRYrlniMjRQTgCeLXu72T4';
  const sheetURL = `https://opensheet.elk.sh/${sheetID}/Sheet1`;

  const formURL = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSdDuE4ErfWKhpntFUftupOLcCSlgCnoONIK8K84yWaKdj53rg/formResponse';
  const entry = {
    name: 'entry.1180938473',
    question: 'entry.1168602063',
    answer: 'entry.1458830104'
  };

  const qaSection = document.getElementById('qa-section');
  const replyPopup = document.getElementById('replyPopup');
  const overlay = document.getElementById('overlay');
  let currentQuestion = '';
  let dataItems = [];

  async function loadData(){
    try {
      const res = await fetch(sheetURL);
      const arr = await res.json();
      // map d·ªØ li·ªáu
      dataItems = arr.map(row => ({
        ts: new Date(row.Timestamp),
        name: row['T√™n'] || '·∫®n danh',
        question: row['C√¢u h·ªèi'] || '',
        answer: row['C√¢u tr·∫£ l·ªùi'] || ''
      })).filter(x => x.question).sort((a,b) => b.ts - a.ts);
      renderList();
    } catch(e){
      console.error('Failed to load sheet:', e);
    }
  }

  function renderList(){
    qaSection.innerHTML = '<h2>C√°c c√¢u h·ªèi ƒë√£ g·ª≠i:</h2>';
    const grouped = {};
    dataItems.forEach(item => {
      const key = item.question;
      if (!grouped[key]) grouped[key] = { ...item, answers: [] };
      if (item.answer) grouped[key].answers.push({ name: item.name, answer: item.answer });
    });
    Object.values(grouped).forEach(q => {
      const card = document.createElement('div');
      card.className = 'answer-box';
      const dateStr = q.ts.toLocaleString('vi-VN', { dateStyle:'short', timeStyle:'short' });
      const count = q.answers.length;
      let answersHtml = '';
      q.answers.forEach(a => {
        answersHtml += `<div class="reply-item"><b>${a.name} tr·∫£ l·ªùi:</b><br>${escapeHtml(a.answer)}</div>`;
      });
      card.innerHTML = `
        <div class="meta"> ${dateStr}<br>üí¨ ${count} c√¢u tr·∫£ l·ªùi</div>
        <h3>${escapeHtml(q.name)} h·ªèi:</h3><p>${escapeHtml(q.question)}</p>
        <div class="replies">${answersHtml}</div>
        <button class="reply-btn" onclick="openReply('${escapeHtml(q.question)}')">Tr·∫£ l·ªùi</button>
      `;
      qaSection.appendChild(card);
    });
  }

  function submitQuestion(){
    const nm = document.getElementById('username').value.trim();
    const qs = document.getElementById('question').value.trim();
    if (!nm || !qs) return alert('Nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n & c√¢u h·ªèi!');
    const fd = new FormData();
    fd.append(entry.name, nm);
    fd.append(entry.question, qs);
    fd.append(entry.answer, '');
    fetch(formURL, { method:'POST', mode:'no-cors', body:fd })
      .then(() => { alert('G·ª≠i c√¢u h·ªèi th√†nh c√¥ng!'); document.getElementById('username').value=''; document.getElementById('question').value=''; loadData(); });
  }

  function openReply(questionText){
    currentQuestion = questionText;
    document.getElementById('replyQuestionText').textContent = questionText;
    replyPopup.style.display = 'block'; overlay.style.display = 'block';
  }
  function closeReplyPopup(){
    replyPopup.style.display = 'none'; overlay.style.display = 'none';
    document.getElementById('replyName').value = '';
    document.getElementById('replyText').value = '';
  }

  function submitReply(){
    const nm = document.getElementById('replyName').value.trim();
    const ans = document.getElementById('replyText').value.trim();
    if (!nm || !ans) return alert('Nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n & c√¢u tr·∫£ l·ªùi!');
    const fd = new FormData();
    fd.append(entry.name, nm);
    fd.append(entry.question, currentQuestion);
    fd.append(entry.answer, ans);
    fetch(formURL, { method:'POST', mode:'no-cors', body:fd })
      .then(() => { alert('G·ª≠i tr·∫£ l·ªùi th√†nh c√¥ng!'); closeReplyPopup(); loadData(); });
  }

  function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }

  document.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>

