<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HATU - H·ªèi ƒê√°p Thi√™n VƒÉn</title>
  <style>
  body {
  background-color: #0b0c10;
  color: #ffffff;
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  padding: 20px;
  line-height: 1.6;
}

h1 {
  color: #00fff7;
  text-align: center;
  font-size: 2.5em;
  margin-bottom: 10px;
  text-shadow: 0 0 10px #00bcd4, 0 0 20px #00bcd4;
}

h2 {
  text-align: center;
  color: #ffc107;
  margin-bottom: 20px;
}

.container {
  max-width: 900px;
  margin: 0 auto;
}

.question-box, .answer-box {
  background: #141414;
  padding: 20px;
  margin-bottom: 25px;
  border-radius: 15px;
  box-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
  position: relative;
  transition: transform 0.3s ease;
}

.question-box:hover, .answer-box:hover {
  transform: scale(1.01);
}

.input-field, textarea {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 8px;
  border: none;
  background: #1f1f1f;
  color: #ffffff;
  font-size: 16px;
}

.button {
  background-color: #00bcd4;
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 12px;
  font-weight: bold;
  font-size: 15px;
  transition: background 0.3s ease;
}

.button:hover {
  background-color: #0097a7;
}

.qa h3 {
  color: #00fff7;
  margin-top: 0;
}

.meta {
  position: absolute;
  top: 12px;
  right: 15px;
  font-size: 12px;
  color: #aaa;
  text-align: right;
}

.replies {
  margin-top: 15px;
  padding-left: 10px;
  border-left: 3px solid #00bcd4;
}

.reply-item {
  background: #232323;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 8px;
  font-size: 15px;
}

.reply-btn {
  background: transparent;
  border: 1px solid #00bcd4;
  color: #00bcd4;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
  margin-top: 10px;
}

.reply-btn:hover {
  background: #00bcd4;
  color: #000;
}

#replyPopup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  width: 90%;
  max-width: 400px;
  transform: translate(-50%, -50%);
  background: #1c1c1c;
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 0 20px #00bcd4;
  z-index: 1000;
}

#replyPopup h3 {
  margin-top: 0;
  color: #00bcd4;
  text-align: center;
}

#replyPopup label {
  font-size: 14px;
  margin-top: 12px;
  display: block;
}

#replyPopup input, #replyPopup textarea {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 8px;
  border: none;
  background: #2a2a2a;
  color: #fff;
}

#replyPopup .button {
  margin-top: 16px;
  width: 100%;
}

#overlay {
  display: none;
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.6);
  z-index: 999;
}
</style>
</head>
<body>
  <div class="container">
    <h1>ü™ê HATU - H·ªèi ƒê√°p Thi√™n VƒÉn</h1>

    <div class="question-box">
      <h2>ƒê·∫∑t c√¢u h·ªèi</h2>
      <input type="text" class="input-field" id="username" placeholder="T√™n c·ªßa b·∫°n (b·∫Øt bu·ªôc)" />
      <textarea rows="4" id="question" class="input-field" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n v·ªÅ thi√™n vƒÉn..."></textarea>
      <button class="button" onclick="submitQuestion()">G·ª≠i c√¢u h·ªèi</button>
    </div>

    <div class="qa" id="qa-section">
      <h2>C√°c c√¢u h·ªèi ƒë√£ g·ª≠i:</h2>
      <!-- N·ªôi dung c√¢u h·ªèi s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y -->
    </div>
  </div>

  <div id="overlay"></div>

  <div id="replyPopup">
    <h3>Tr·∫£ l·ªùi c√¢u h·ªèi</h3>
    <p><b>C√¢u h·ªèi:</b> <span id="replyQuestionText"></span></p>
    <label for="replyName">T√™n c·ªßa b·∫°n (b·∫Øt bu·ªôc):</label>
    <input type="text" id="replyName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" />
    <label for="replyText">C√¢u tr·∫£ l·ªùi (b·∫Øt bu·ªôc):</label>
    <textarea id="replyText" rows="4" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi"></textarea>
    <button class="button" onclick="submitReply()">G·ª≠i tr·∫£ l·ªùi</button>
    <button class="button" style="background:#555;margin-top:8px;" onclick="closeReplyPopup()">H·ªßy</button>
  </div>

<!-- _________________________________ -->

  <script>
  const sheetID = '18cFMlSc7dlwHNZlUQ5y7BMRYrlniMjRQTgCeLXu72T4';
  const sheetURL = `https://opensheet.elk.sh/${sheetID}/Sheet1`;

  const formURL = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSdDuE4ErfWKhpntFUftupOLcCSlgCnoONIK8K84yWaKdj53rg/formResponse';
  const entry = {
    name: 'entry.1180938473',
    question: 'entry.1168602063',
    answer: 'entry.1458830104'
  };

  const qaSection = document.getElementById('qa-section');
  const replyPopup = document.getElementById('replyPopup');
  const overlay = document.getElementById('overlay');
  let currentQuestion = '';
  let dataItems = [];

  async function loadData(){
    try {
      const res = await fetch(sheetURL);
      const arr = await res.json();
      // map d·ªØ li·ªáu
      dataItems = arr.map(row => ({
        ts: parseDate(row['D·∫•u th·ªùi gian']),
        name: row['T√™n'] || '·∫®n danh',
        question: row['C√¢u h·ªèi'] || '',
        answer: row['C√¢u tr·∫£ l·ªùi'] || ''
      })).filter(x => x.question).sort((a,b) => b.ts - a.ts);
      renderList();
    } catch(e){
      console.error('Failed to load sheet:', e);
    }
  }

  function parseDate(str) {
  if (!str) return new Date(NaN);
  // Gi·∫£ s·ª≠ chu·ªói l√† ƒë·ªãnh d·∫°ng: "02/08/2025, 14:30:00"
  const parts = str.split(/[\s,]+/);
  const [day, month, year] = parts[0].split('/');
  const time = parts[1] || '00:00:00';
  return new Date(`${year}-${month}-${day}T${time}`);
}


  function renderList(){
    qaSection.innerHTML = '<h2>C√°c c√¢u h·ªèi ƒë√£ g·ª≠i:</h2>';
    const grouped = {};
    dataItems.forEach(item => {
      const key = item.question;
      if (!grouped[key]) {
    grouped[key] = { name: '', question: item.question, ts: item.ts, answers: [] };
    }
        if (!item.answer) {
    grouped[key].name = item.name;
    grouped[key].ts = item.ts;
    }
        if (item.answer) {
    grouped[key].answers.push({ name: item.name, answer: item.answer });
    }

      if (item.answer && !grouped[key].answers.some(a => a.name === item.name && a.answer === item.answer)) {
        grouped[key].answers.push({ name: item.name, answer: item.answer });
    }

    });
    Object.values(grouped).forEach(q => {
      const card = document.createElement('div');
      card.className = 'answer-box';
      const dateStr = q.ts.toLocaleString('vi-VN', { dateStyle:'short', timeStyle:'short' });
      const count = q.answers.length;
      let answersHtml = '';
      q.answers.forEach(a => {
        answersHtml += `<div class="reply-item"><b>${a.name} tr·∫£ l·ªùi:</b><br>${escapeHtml(a.answer)}</div>`;
      });
      card.innerHTML = `
        <div class="meta"> ${dateStr}<br>üí¨ ${count} c√¢u tr·∫£ l·ªùi</div>
        <h3>${escapeHtml(q.name)} h·ªèi:</h3><p>${escapeHtml(q.question)}</p>
        <div class="replies">${answersHtml}</div>
        <button class="reply-btn" onclick="openReply('${escapeHtml(q.question)}')">Tr·∫£ l·ªùi</button>
      `;
      qaSection.appendChild(card);
    });
  }

  function submitQuestion(){
    const nm = document.getElementById('username').value.trim();
    const qs = document.getElementById('question').value.trim();
    if (!nm || !qs) return alert('Nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n & c√¢u h·ªèi!');
    const fd = new FormData();
    fd.append(entry.name, nm);
    fd.append(entry.question, qs);
    fd.append(entry.answer, '');
    fetch(formURL, { method:'POST', mode:'no-cors', body:fd })
      .then(() => { alert('G·ª≠i c√¢u h·ªèi th√†nh c√¥ng!'); document.getElementById('username').value=''; document.getElementById('question').value=''; loadData(); });
  }

  function openReply(questionText){
    currentQuestion = questionText;
    document.getElementById('replyQuestionText').textContent = questionText;
    replyPopup.style.display = 'block'; overlay.style.display = 'block';
  }
  function closeReplyPopup(){
    replyPopup.style.display = 'none'; overlay.style.display = 'none';
    document.getElementById('replyName').value = '';
    document.getElementById('replyText').value = '';
  }

  function submitReply(){
    const nm = document.getElementById('replyName').value.trim();
    const ans = document.getElementById('replyText').value.trim();
    if (!nm || !ans) return alert('Nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n & c√¢u tr·∫£ l·ªùi!');
    const fd = new FormData();
    fd.append(entry.name, nm);
    fd.append(entry.question, currentQuestion);
    fd.append(entry.answer, ans);
    fetch(formURL, { method:'POST', mode:'no-cors', body:fd })
      .then(() => { alert('G·ª≠i tr·∫£ l·ªùi th√†nh c√¥ng!'); closeReplyPopup(); loadData(); });
  }

  function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }

  document.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>
